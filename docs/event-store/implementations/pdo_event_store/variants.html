
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="HandheldFriendly" content="True"/>
<title>Variants</title>
<link rel="shortcut icon" href="http://getprooph.org/images/ico/prooph-logo@0.5x.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://getprooph.org/images/ico/apple-touch-icon-144-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://getprooph.org/images/ico/apple-touch-icon-114-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://getprooph.org/images/ico/apple-touch-icon-72-precomposed.png">
<link rel="apple-touch-icon-precomposed" href="http://getprooph.org/images/ico/apple-touch-icon-57-precomposed.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@prooph_software">
<meta name="twitter:title" content="prooph components">
<meta name="twitter:description" content="Enterprise-ready CQRS and Event Sourcing packages for PHP with support for the most famous PHP web frameworks">
<meta name="twitter:image" content="http://getprooph.org/images/prooph-components-intro.png">
    <link rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/lumen/bootstrap.min.css">
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-ghcolors.css"/>
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-linenumbers.css"/>
<style>
    body, html {
        height: 100%;
        padding-top: 36px;
        position: relative;
    }

    img {
        max-width: 100%;
    }

    code span {
        white-space: nowrap;
    }
    code span.comment {
        white-space: pre;
    }

    .highlight {
        background: #FFFF88;
    }

    .page-wrapper {
        min-height: 100%;
        padding-bottom: 170px;
        position: relative;
    }

    .box-header {
        position: relative;
    }

    /* Header Section */
    header {
        background: white;
        color: black;
        font-size: 16px;
        font-weight: 300;
    }

    h1:first-child {
        margin-top: 0;
    }

    /* anchor link will be displayed after the static top nav */
    h1:before,
    h2:before,
    h3:before,
    h4:before,
    h5:before,
    h6:before {
        display: block;
        content: " ";
        margin-top: -64px;
        height: 64px;
        visibility: hidden;
    }

    .navbar-brand {
        padding: 0;
    }

    .navbar-brand img {
        max-height: 100%;
    }

    /* Content Section */
    #content {
        margin-bottom: 17px;
        font-size: 17px;
        min-height: 200px;
    }

    .breadcrumb {
        position: relative;
        z-index: 999;
    }

    .links {
        background: #f8f8f8;
        border-top: 1px solid #e5e5e5;
        border-bottom: 1px solid #e5e5e5;
        padding: 16px 0;
    }

    .links .prev {
        text-align: left;
    }

    .links .parent {
        text-align: center;
    }

    .links .next {
        text-align: right;
    }

    /* Search */
    .form-search {
        position: absolute;
        right: 0;
        top: 0;
        z-index: 999;
    }

    @media (max-width: 767px) {
        .form-search {
            position: relative;
            margin-top: 0;
        }
    }

    .form-search .form-control {
        border: 0;
        width: 80px;
    }

    @media (max-width: 767px) {
        .form-search .form-control {
            width: 100% !important;
        }
    }

    .form-search .list-search-results {
        position: relative;
    }

    .form-search .list-search-results ul {
        background: #eee;
        border: 1px solid inherit;
        list-style: none;
        max-height: 300px;
        overflow: auto;
        padding: 0;
        position: absolute;
        width: 100%;
        z-index: 999;
    }

    .form-search .list-search-results ul li:nth-child(even) {
        background: rgba(255, 255, 255, 0.3)
    }

    .form-search .list-search-results ul li.selected {
        background: #ccc;
    }

    .form-search .list-search-results ul li a {
        display: block;
        padding: 4px 8px;
    }

    /* TOC */
    .list-toc {
        padding: 0;
    }

    .list-toc .list-group-item {
        background: 0 none;
        position: relative;
        font-weight: bold;
        padding: 0;
        margin: 0;
    }

    .list-toc li .text-number {
        padding-left: 20px;
    }
    .list-toc li li .text-number {
        padding-left: 40px;
    }
    .list-toc li li li .text-number {
        padding-left: 60px;
    }
    .list-toc li li li li .text-number {
        padding-left: 80px;
    }
    .list-toc li li li li li .text-number {
        padding-left: 100px;
    }
    .list-toc .text-number {
        padding-left: 100px;
    }

    .list-toc .list-group-item .row {
        padding: 7px 0 7px;
    }

    .list-toc .list-group-item .bbt-toc-toggle {
        display: block;
        position: absolute;
        top: 5px;
        right: 10px;
        font-weight: normal;
    }

    .list-toc .list-group-item .bbt-toc-toggle:before {
        content: "";
        display: block;
    }

    .list-toc .list-group-item .bbt-toc-toggle.collapsed:before {
        content: "";
        display: block;
    }

    .list-toc > li:nth-child(2n+1) {
        background: rgba(0, 0, 0, 0.03);
    }

    .bbt-theme-cyborg .list-toc > li:nth-child(2n+1),
    .bbt-theme-darkly .list-toc > li:nth-child(2n+1),
    .bbt-theme-slate .list-toc > li:nth-child(2n+1),
    .bbt-theme-superhero .list-toc > li:nth-child(2n+1) {
        background: rgba(255, 255, 255, 0.05);
    }

    .list-toc .list-group-item {
        border-bottom: 0 none;
        border-left: 0 none;
        border-right: 0 none;
        font-size: inherit;
    }

    .list-toc .list-group-item:first-child {
        border-top-right-radius: 0;
        border-top-left-radius: 0;
    }

    .list-toc .list-group-item:last-child {
        border-bottom-right-radius: 0;
        border-bottom-left-radius: 0;
    }

    /* Left navigation */
    .nav-left ul li a {
        padding-top: 3px;
        padding-bottom: 3px;
        border-left: 1px solid transparent;
    }

    .nav-left ul li.active a,
    .nav-left ul li a:hover {
        background: none !important;
        color: inherit;
        border-color: inherit;
    }

    .navbar-top {
        position: relative;
    }

    .affix {
        top: 60px;
    }

    .badge {
        border-radius: 4px;
        padding: 5px;
    }

    /* Footer Section */
    footer {
        color: black;
        background: white;
        width: 100%;
        position: absolute;
        bottom: 0;
    }

    footer #copyright {
        padding: 30px;
        text-align: center;
        color: #444;
    }

    footer #copyright p {
        margin: 0;
    }

    footer #copyright span a {
        color: white;
    }

    /* Top Navigation */
    @media (max-width: 767px) {
        ul.navbar-nav {
            margin: 0 -15px
        }

        ul.navbar-nav li {
            border-radius: 0;
        }

        ul.navbar-nav li ul {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 0;
            box-shadow: none;
            display: block;
            float: none;
            left: auto;
            padding: 0;
            position: static;
        }

        ul.navbar-nav li ul li a {
            padding: 8px 30px;
        }

        ul.navbar-nav li ul li ul li a {
            padding: 6px 40px;
        }
    }

    @media (min-width: 768px) {

        ul.navbar-nav li {
            display: block;
            position: relative;
            float: left;
        }

        ul.navbar-nav li ul {
            display: none;
        }

        ul.navbar-nav li a {
            display: block;
        }

        ul.navbar-nav li:hover > ul {
            display: block;
            position: absolute;
        }

        ul.navbar-nav li:hover li {
            float: none;
        }

        ul.navbar-nav ul ul {
            left: 100%;
            top: 0;
        }
    }
</style>
    <style>
    /* Header Section */
    header {
        font-size: 14px;
        font-weight: 400;
    }

    .prooph-logo {
        float: left;
        margin-left: 8px;
        margin-right: 8px;
        transition-timing-function: ease-in-out;
        transition: all 5s;
        height: 50px;
        padding: 5px;
    }

    .prooph-logo:hover {
        transition: all .7s;
        transition-timing-function: ease-out;
        transform: rotate(360deg);
    }

    #forkongithub a {
        background: #000;
        color: #fff;
        text-decoration: none;
        font-family: arial, sans-serif;
        text-align: center;
        font-weight: bold;
        padding: 5px 40px;
        font-size: 1rem;
        line-height: 2rem;
        position: relative;
        transition: 0.5s;
    }

    #forkongithub a:hover {
        background: #c11;
        color: #fff;
    }

    #forkongithub a::before, #forkongithub a::after {
        content: "";
        width: 100%;
        display: block;
        position: absolute;
        top: 1px;
        left: 0;
        height: 1px;
        background: #fff;
    }

    #forkongithub a::after {
        bottom: 1px;
        top: auto;
    }

    @media screen and (min-width: 800px) {
        #forkongithub {
            position: fixed;
            display: block;
            top: 0;
            right: 0;
            width: 200px;
            overflow: hidden;
            height: 200px;
            z-index: 1000;
        }

        #forkongithub a {
            width: 200px;
            position: absolute;
            top: 80px;
            right: -60px;
            transform: rotate(45deg);
            -webkit-transform: rotate(45deg);
            -ms-transform: rotate(45deg);
            -moz-transform: rotate(45deg);
            -o-transform: rotate(45deg);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.8);
        }
    }
</style>
</head>
<body data-spy="scroll" data-target="#sideNav" data-offset="50" class="bbt-theme-lumen">
<div class="page-wrapper">
    <header>
    
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="box-header container">
        <form class="form-search navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text"
                       placeholder="Search"
                       class="js-search-input form-control"
                       data-roothref="/">

                <div class="js-search-results"></div>
            </div>
        </form>

        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#js-navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://getprooph.org">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="prooph-logo">
                    <defs>
                        <style>
                            .cls-1{fill:#04a1b0;}.cls-2{fill:#26896c;}.cls-3{fill:#eeca50;}.cls-4{fill:#eb6842;}.cls-5{fill:#cc3340;}.cls-6{fill:#715671;}
                        </style>
                    </defs>
                    <title>prooph-logo</title>
                    <g id="artwork">
                        <g id="Layer_5" data-name="Layer 5">
                            <path class="cls-1"
                                  d="M57.22,17,67.84,35.43a1.77,1.77,0,0,0,1.53.89h61.25a1.77,1.77,0,0,0,1.53-.89L142.78,17a1.77,1.77,0,0,0-1.53-2.66H58.76A1.77,1.77,0,0,0,57.22,17Z"/>
                            <path class="cls-2"
                                  d="M29.54,94.68l30.63-53a1.77,1.77,0,0,0,0-1.77L49.55,21.48a1.77,1.77,0,0,0-3.07,0L5.24,92.91a1.77,1.77,0,0,0,1.53,2.66H28A1.77,1.77,0,0,0,29.54,94.68Z"/>
                            <path class="cls-3"
                                  d="M60.16,158.36l-30.63-53a1.77,1.77,0,0,0-1.53-.89H6.78a1.77,1.77,0,0,0-1.53,2.66l41.24,71.43a1.77,1.77,0,0,0,3.07,0l10.61-18.38A1.77,1.77,0,0,0,60.16,158.36Z"/>
                            <path class="cls-4"
                                  d="M130.63,163.68H69.37a1.77,1.77,0,0,0-1.53.89L57.22,183a1.77,1.77,0,0,0,1.53,2.66h82.48a1.77,1.77,0,0,0,1.53-2.66l-10.61-18.38A1.77,1.77,0,0,0,130.63,163.68Z"/>
                            <path class="cls-5"
                                  d="M170.46,105.32l-30.63,53a1.77,1.77,0,0,0,0,1.77l10.61,18.38a1.77,1.77,0,0,0,3.07,0l41.24-71.43a1.77,1.77,0,0,0-1.53-2.66H172A1.77,1.77,0,0,0,170.46,105.32Z"/>
                            <path class="cls-6"
                                  d="M139.84,41.64l30.63,53a1.77,1.77,0,0,0,1.53.89h21.23a1.77,1.77,0,0,0,1.53-2.66L153.52,21.48a1.77,1.77,0,0,0-3.07,0L139.84,39.86A1.77,1.77,0,0,0,139.84,41.64Z"/>
                        </g>
                    </g>
                </svg>
            </a>

        </div>

        <div class="collapse navbar-collapse" id="js-navbar-collapse">
            
    
    <ul class="nav navbar-nav">
                        <li>
    <a href="/tutorial/">Tutorial</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/tutorial/introduction.html">Introduction</a>

    </li>
                        <li>
    <a href="/tutorial/why_event_sourcing.html">Why Event Sourcing?</a>

    </li>
                        <li>
    <a href="/tutorial/event_sourcing_basics.html">Event Sourcing Basics</a>

    </li>
                        <li>
    <a href="/tutorial/testing_aggregates.html">Testing Aggregates</a>

    </li>
                        <li>
    <a href="/tutorial/aggregate_dependencies.html">Aggregate Dependencies</a>

    </li>
                        <li>
    <a href="/tutorial/process_managers.html">Process Managers</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/service-bus/">Service Bus</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/service-bus/overview.html">PSB Overview</a>

    </li>
                        <li>
    <a href="/service-bus/message_bus.html">Message Buses</a>

    </li>
                        <li>
    <a href="/service-bus/plugins.html">PSB Plugins</a>

    </li>
                        <li>
    <a href="/service-bus/async_message_producer.html">Async Message Producer</a>

    </li>
                        <li>
    <a href="/service-bus/factories.html">Interop + Factories</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/event-store/">Event Store</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/event-store/intro.html">Introduction</a>

    </li>
                        <li>
    <a href="/event-store/implementations/">Implementations</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/event-store/implementations/pdo_event_store/">PDO Event Store</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/event-store/event_store_plugins.html">Plugins & Extensions</a>

    </li>
                        <li>
    <a href="/event-store/projections.html">Projections</a>

    </li>
                        <li>
    <a href="/event-store/standard_projections/">Standard Projections</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/event-store/standard_projections/overview.html">Overview</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/event-store/upcasting.html">Upcasting</a>

    </li>
                        <li>
    <a href="/event-store/interop_factories.html">Interop Factories</a>

    </li>
                        <li>
    <a href="/event-store/migration.html">Migration from v6 to v7</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/event-sourcing/">Event Sourcing</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/event-sourcing/intro.html">Introduction</a>

    </li>
                        <li>
    <a href="/event-sourcing/repositories.html">Working with Repositories</a>

    </li>
                        <li>
    <a href="/event-sourcing/snapshots/">Aggregate Snapshots</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/event-sourcing/snapshots/intro.html">Introduction</a>

    </li>
                        <li>
    <a href="/event-sourcing/snapshots/snapshotter/">Snapshotter</a>

    </li>
                        <li>
    <a href="/event-sourcing/snapshots/snapshot_store/">Snapshot Store</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/event-sourcing/inheritance.html">Inheritance with Aggregate Roots</a>

    </li>
                        <li>
    <a href="/event-sourcing/interop_factories.html">Interop Factories</a>

    </li>
                        <li>
    <a href="/event-sourcing/migration.html">Migration from v4 to v5</a>

    </li>
            </ul>

    </li>
            </ul>

        </div>
    </div>
</nav>
</header>
<div class="container">
    <ol class="breadcrumb">
                        <li><a href="/">prooph components documentation</a></li>
                                <li><a href="/event-store/">Event Store</a></li>
                                <li><a href="/event-store/implementations/">Implementations</a></li>
                                <li><a href="/event-store/implementations/pdo_event_store/">PDO Event Store</a></li>
                                <li class="active">Variants</li>
            </ol>
    <div class="row">

                <div class="col-md-3">
            <nav class="nav-left hidden-xs hidden-sm" id="sideNav">
    <ul class="nav nav-stacked" data-spy="affix" data-offset-top="59" role="tablist">
                                <li>
                <a href="#3-2-1-2" title="Variants">Variants</a>
            </li>
                                <li>
                <a href="#3-2-1-2-1" title="Differences&#x20;of&#x20;MariaDb-&#x2F;MySql-&#x20;&amp;amp&#x3B;&#x20;PostgresEventStore">Differences of MariaDb-/...</a>
            </li>
                                <li>
                <a href="#3-2-1-2-2" title="Event&#x20;streams&#x20;&#x2F;&#x20;projections&#x20;table">Event streams / projecti...</a>
            </li>
                                <li>
                <a href="#3-2-1-2-3" title="Load&#x20;batch&#x20;size">Load batch size</a>
            </li>
                                <li>
                <a href="#3-2-1-2-4" title="PDO&#x20;Connection&#x20;for&#x20;event-store&#x20;and&#x20;projection&#x20;manager">PDO Connection for event...</a>
            </li>
                                <li>
                <a href="#3-2-1-2-5" title="Persistance&#x20;Strategies">Persistance Strategies</a>
            </li>
                                                                        </ul>
</nav>
        </div>
                <div class="col-md-9">
<div id="section-main"><h1 id="3-2-1-2">Variants</h1>
<p>The PDO Event Store is an implementation of <a href="https://github.com/prooph/event-store">prooph/event-store</a> that supports
MySQL and MariaDB as well as PostgreSQL.</p>
<p>For a better understanding, we recommend to read the event-store docs, first.</p>
<h2 id="3-2-1-2-1">Differences of MariaDb-/MySql- &amp; PostgresEventStore</h2>
<p>The PostgresEventStore has a better performance (at least with default database configuration) and implements the
<code>TransactionalEventStore</code> interface. If you need maximum performance or transaction support, we recommend to use the
PostgresEventStore over the MariaDb-/MySqlEventStore.</p>
<h2 id="3-2-1-2-2">Event streams / projections table</h2>
<p>All known event streams are stored in an event stream table, so with a simple table lookup, you can find out what streams
are available in your store.</p>
<p>Same goes for the projections, all known projections are stored in a single table, so you can see what projections are
available, and what their current state / stream positition / status is.</p>
<h2 id="3-2-1-2-3">Load batch size</h2>
<p>When reading from an event streams with multiple aggregates (especially when using projections), you could end of with
millions of events loaded in memory. Therefor the pdo-event-store will load events only in batches of 1000 by default.
You can change to value to something higher to achieve even more performance with higher memory usage, or decrease it
to reduce memory usage even more, with the drawback of having a not as good performance.</p>
<h2 id="3-2-1-2-4">PDO Connection for event-store and projection manager</h2>
<p>It is important to use the same database for event-store and projection manager, you could use distinct pdo connections
if you want to, but they should be both connected to the same database. Otherwise you will run into issues, because the
projection manager needs to query the underlying database table of the event-store for its querying API.</p>
<p>It's recommended to just use the same pdo connection instance for both.</p>
<h2 id="3-2-1-2-5">Persistance Strategies</h2>
<p>This component ships with 9 default persistance strategies:</p>
<ul>
<li>MariaDbAggregateStreamStrategy</li>
<li>MariaDbSimpleStreamStrategy</li>
<li>MariaDbSingleStreamStrategy</li>
<li>MySqlAggregateStreamStrategy</li>
<li>MySqlSimpleStreamStrategy</li>
<li>MySqlSingleStreamStrategy</li>
<li>PostgresAggregateStreamStrategy</li>
<li>PostgresSimpleStreamStrategy</li>
<li>PostgresSingleStreamStrategy</li>
</ul>
<p>All persistance strategies have the following in common:</p>
<p>The generated table name for a given stream is:</p>
<p><code>'_' . sha1($streamName-&gt;toString()</code></p>
<p>so a sha1 hash of the stream name, prefixed with an underscore is the used table name.
You can query the <code>event_streams</code> table to get real stream name to stream name mapping.</p>
<p>You can implement your own persistance strategy by implementing the <code>Prooph\EventStore\Pdo\PersistenceStrategy</code> interface.</p>
<h3 id="3-2-1-2-5-1">AggregateStreamStrategy</h3>
<p>This stream strategy should be used together with event-sourcing, if you use one stream per aggregate. For example, you have 2 instances of two
different aggregates named <code>user-123</code>, <code>user-234</code>, <code>todo-345</code> and <code>todo-456</code>, you would have 4 different event streams,
one for each aggregate.</p>
<p>This stream strategy is the most performant of all, but it will create a lot of database tables, which is something not
everyone likes (especially DB admins).</p>
<p>All needed database tables will be created automatically for you.</p>
<h3 id="3-2-1-2-5-2">SingleStreamStrategy</h3>
<p>This stream strategy should be used together with event-sourcing, if you want to store all events of an aggregate type into a single stream, for example
<code>user-123</code> and <code>user-234</code> should both be stored into a stream called <code>user</code>.</p>
<p>You can also store all stream of all aggregate types into a single stream, for example your aggregates <code>user-123</code>,
<code>user-234</code>, <code>todo-345</code> and <code>todo-456</code> can all be stored into a stream called <code>event_stream</code>.</p>
<p>This stream strategy is slightly less performant then the aggregate stream strategy.</p>
<p>You need to setup the database table yourself when using this strategy. An example script to do that can be <a href="https://github.com/prooph/proophessor-do/blob/master/scripts/create_event_stream.php">found here</a>.</p>
<h3 id="3-2-1-2-5-3">SimpleStreamStrategy</h3>
<p>This stream strategy is not meant to be used for event-sourcing. It will create simple event streams without any constraints
at all, so having two events of the same aggregate with the same version will not rise any error.</p>
<p>This is very useful for projections, where you copy events from one stream to another (the resulting stream may need to use
the simple stream strategy) or when you want to use the event-store outside the scope of event-sourcing.</p>
<p>You need to setup the database table yourself when using this strategy. An example script to do that can be <a href="https://github.com/prooph/proophessor-do/blob/master/scripts/create_event_stream.php">found here</a>.</p>
<h3 id="3-2-1-2-5-4">Using custom stream strategies</h3>
<p>When you query the event streams a lot, it might be a good idea to create your own stream strategy, so you can add
custom indexes to your database tables. When using with the MetadataMatcher, take care that you add the metadata
matches in the right order, so they can match your indexes.</p>
<h3 id="3-2-1-2-5-5">Disable transaction handling</h3>
<p>You can configure the event store to disable transaction handling completely. In order to do this, set the last parameter
in the constructor to true (or configure your interop config factory accordingly, key is <code>disable_transaction_handling</code>).</p>
<p>Enabling this feature will disable all transaction handling and you have to take care yourself to start, commit and rollback
transactions.</p>
<p>Note: This could lead to problems using the event store, if you did not manage to handle the transaction handling accordingly.
This is your problem and we will not provide any support for problems you encounter while doing so.</p>
</div>        </div>
    </div>
</div>

<footer>
    <div class="links">
        <div class="container">
            <div class="row">
                <div class="prev col-xs-6">
                                            <a href="/event-store/implementations/pdo_event_store/intro.html">Previous</a>                                    </div>
                <div class="next col-xs-6">
                                            <a href="/event-store/implementations/pdo_event_store/interop_factories.html">Next</a>                                    </div>
            </div>
        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>Powered by <a href="https://github.com/tobiju/bookdown-bootswatch-templates" title="Visit project to generate your own docs">Bookdown Bootswatch Templates</a>.</p>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
<span id="forkongithub"><a href="https://github.com/prooph/pdo-event-store">Fork me on GitHub</a></span><script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="http://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
<script src="https://tobiju.github.io/share/prismjs/main.js"></script>
<script src="https://tobiju.github.io/share/prismjs/prism.js"></script>
<script type="text/javascript">

    function Search() {
        this.store = {};
        this.index = lunr(function () {
            this.ref('id');
            this.field('title', {boost: 10});
            this.field('content');
        });
        this.searchResults = $('.js-search-results').addClass('list-search-results');
    }

    Search.prototype = {
        constructor: Search,
        init: function () {
            this.createIndex();
            this.bindEvents();
        },
        createIndex: function () {
            var $this = this,
                indexFilePath = $('.js-search-input').data('roothref') + 'index.json';

            $.getJSON(indexFilePath, function (data) {
                $.each(data, function (key, item) {
                    $this.index.add({
                        id: item.id,
                        title: item.title,
                        content: item.content
                    });

                    $this.store[item.id] = {
                        href: item.id,
                        title: item.title,
                        content: item.content
                    }
                });
            });
        },
        bindEvents: function () {
            var $this = this;

            $('html')
                .on('click', function (event) {
                    $this.close($(this), event);
                });

            $('.js-search-input, .js-search-results')
                .on('click', function (event) {
                    $this.click($(this), event);
                });

            $('.js-search-input')
                .on('focus', function (event) {
                    $this.focus($(this), event);
                })
                .on('keyup', function (event) {
                    $this.search($(this), event)
                })
                .on('keydown', function (event) {
                    if ($('.js-search-results ul').is(':visible')){
                        $this.navigation($(this), event)
                    }
                })
        },
        click: function (element, event) {
            event.stopPropagation();
        },
        focus: function (element, event) {
            this.searchInputWidth = element.css('width');
            element.animate({
                'width': 600
            }, 500);
            $('#js-navbar-collapse > ul').fadeOut();
        },
        close: function (element, event) {
            var $this = this;

            $('.js-search-results').hide();
            $('.js-search-input').animate({
                'width': $this.searchInputWidth
            }, 500);
            $('#js-navbar-collapse > ul').fadeIn();
        },
        search: function (element, event) {
            var $this = this;

            if (event.keyCode == 13 || event.keyCode == 38 || event.keyCode == 40) {
                return;
            }

            var query = element.val(),
                results = $this.index.search(query);

            if (!results.length) {
                $this.searchResults.empty();
                return;
            }

            var resultsList = results.reduce(function (ul, result) {
                var item = $this.store[result.ref];
                var title = $('<b>').text(item.title);

                var cropText = $this.cropText(item.content, query);
                if (cropText.length === 0) {
                    cropText = $('<p>').html(item.content.substring(0, 120) + "...");
                }
                var content = content = $('<p>').html(cropText);

                var div = $('<div>')
                    .append(title)
                    .append(content);
                var a = $('<a>').attr('href', item.href)
                    .append(div);
                var li = $('<li>')
                    .append(a);
                ul.append(li);

                return ul;
            }, $('<ul>'));

            this.searchResults.html(resultsList);

            $('.js-search-results').show();
            $(".js-search-results li:first-child").addClass('selected');
        },
        cropText: function (content, query) {
            var cropedText = '',
                re = new RegExp("\\s?(.{0,30})?" + query + ".*?\\b(.{0,30}.)?\\s?", "gi");

            $.each(content.match(re), function (key, value) {
                cropedText += '...' + value + '...';
            });

            return cropedText;
        },
        navigation: function (element, event) {
            var selected = null,
                listSelector = ".js-search-results ul",
                listItemSelector = listSelector + " li",
                selectedListItemSelector = listItemSelector + ".selected",
                selectedListItemSelectorAnchor = listItemSelector + ".selected a";

            // enter
            if (event.keyCode == 13) {
                event.preventDefault();
                this.close();
                window.location.replace($(selectedListItemSelectorAnchor).attr('href'));
            }

            // up
            if (event.keyCode == 38) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.prev().length == 0) {
                    selected.siblings().last().addClass("selected");
                } else {
                    selected.prev().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListUp(selected);
            }

            // down
            if (event.keyCode == 40) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.next().length == 0) {
                    selected.siblings().first().addClass("selected");
                } else {
                    selected.next().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListDown(selected);
            }
        },
        scrollListDown: function (element) {
            var ul = element.parent(),
                ulHeight = ul.height(),
                ulBottomPosition = ulHeight + ul.scrollTop(),
                liBottomPosition = element.position().top + element.height();

            if (liBottomPosition > ulBottomPosition) {
                ul.scrollTop(liBottomPosition - ulHeight);
            }

            if (element.is(':first-child')) {
                ul.scrollTop(0);
            }
        },
        scrollListUp: function (element) {
            var ul = element.parent(),
                ulTopPosition = ul.scrollTop(),
                liTopPosition = element.position().top;

            if (liTopPosition < ulTopPosition) {
                ul.scrollTop(element.position().top);
            }

            if (element.is(':last-child')) {
                ul.scrollTop(element.position().top - element.height());
            }
        }
    };

    $(function () {
        var search = new Search();
        search.init();
    });
</script>
</body></html>
