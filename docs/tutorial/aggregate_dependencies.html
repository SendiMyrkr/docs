
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="HandheldFriendly" content="True"/>
<title>Aggregate Dependencies</title>
<link rel="shortcut icon" href="http://getprooph.org/images/ico/prooph-logo@0.5x.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://getprooph.org/images/ico/apple-touch-icon-144-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://getprooph.org/images/ico/apple-touch-icon-114-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://getprooph.org/images/ico/apple-touch-icon-72-precomposed.png">
<link rel="apple-touch-icon-precomposed" href="http://getprooph.org/images/ico/apple-touch-icon-57-precomposed.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@prooph_software">
<meta name="twitter:title" content="prooph components">
<meta name="twitter:description" content="Enterprise-ready CQRS and Event Sourcing packages for PHP with support for the most famous PHP web frameworks">
<meta name="twitter:image" content="http://getprooph.org/images/prooph-components-intro.png">
    <link rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/cerulean/bootstrap.min.css">
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-ghcolors.css"/>
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-linenumbers.css"/>
<style>
    body, html {
        height: 100%;
        padding-top: 36px;
        position: relative;
    }

    img {
        max-width: 100%;
    }

    code span {
        white-space: nowrap;
    }
    code span.comment {
        white-space: pre;
    }

    .highlight {
        background: #FFFF88;
    }

    .page-wrapper {
        min-height: 100%;
        padding-bottom: 170px;
        position: relative;
    }

    .box-header {
        position: relative;
    }

    /* Header Section */
    header {
        background: white;
        color: black;
        font-size: 16px;
        font-weight: 300;
    }

    h1:first-child {
        margin-top: 0;
    }

    /* anchor link will be displayed after the static top nav */
    h1:before,
    h2:before,
    h3:before,
    h4:before,
    h5:before,
    h6:before {
        display: block;
        content: " ";
        margin-top: -64px;
        height: 64px;
        visibility: hidden;
    }

    .navbar-brand {
        padding: 0;
    }

    .navbar-brand img {
        max-height: 100%;
    }

    /* Content Section */
    #content {
        margin-bottom: 17px;
        font-size: 17px;
        min-height: 200px;
    }

    .breadcrumb {
        position: relative;
        z-index: 999;
    }

    .links {
        background: #f8f8f8;
        border-top: 1px solid #e5e5e5;
        border-bottom: 1px solid #e5e5e5;
        padding: 16px 0;
    }

    .links .prev {
        text-align: left;
    }

    .links .parent {
        text-align: center;
    }

    .links .next {
        text-align: right;
    }

    /* Search */
    .form-search {
        position: absolute;
        right: 0;
        top: 0;
        z-index: 999;
    }

    @media (max-width: 767px) {
        .form-search {
            position: relative;
            margin-top: 0;
        }
    }

    .form-search .form-control {
        border: 0;
        width: 80px;
    }

    @media (max-width: 767px) {
        .form-search .form-control {
            width: 100% !important;
        }
    }

    .form-search .list-search-results {
        position: relative;
    }

    .form-search .list-search-results ul {
        background: #eee;
        border: 1px solid inherit;
        list-style: none;
        max-height: 300px;
        overflow: auto;
        padding: 0;
        position: absolute;
        width: 100%;
        z-index: 999;
    }

    .form-search .list-search-results ul li:nth-child(even) {
        background: rgba(255, 255, 255, 0.3)
    }

    .form-search .list-search-results ul li.selected {
        background: #ccc;
    }

    .form-search .list-search-results ul li a {
        display: block;
        padding: 4px 8px;
    }

    /* TOC */
    .list-toc {
        padding: 0;
    }

    .list-toc .list-group-item {
        background: 0 none;
        position: relative;
        font-weight: bold;
        padding: 0;
        margin: 0;
    }

    .list-toc li .text-number {
        padding-left: 20px;
    }
    .list-toc li li .text-number {
        padding-left: 40px;
    }
    .list-toc li li li .text-number {
        padding-left: 60px;
    }
    .list-toc li li li li .text-number {
        padding-left: 80px;
    }
    .list-toc li li li li li .text-number {
        padding-left: 100px;
    }
    .list-toc .text-number {
        padding-left: 100px;
    }

    .list-toc .list-group-item .row {
        padding: 7px 0 7px;
    }

    .list-toc .list-group-item .bbt-toc-toggle {
        display: block;
        position: absolute;
        top: 5px;
        right: 10px;
        font-weight: normal;
    }

    .list-toc .list-group-item .bbt-toc-toggle:before {
        content: "";
        display: block;
    }

    .list-toc .list-group-item .bbt-toc-toggle.collapsed:before {
        content: "";
        display: block;
    }

    .list-toc > li:nth-child(2n+1) {
        background: rgba(0, 0, 0, 0.03);
    }

    .bbt-theme-cyborg .list-toc > li:nth-child(2n+1),
    .bbt-theme-darkly .list-toc > li:nth-child(2n+1),
    .bbt-theme-slate .list-toc > li:nth-child(2n+1),
    .bbt-theme-superhero .list-toc > li:nth-child(2n+1) {
        background: rgba(255, 255, 255, 0.05);
    }

    .list-toc .list-group-item {
        border-bottom: 0 none;
        border-left: 0 none;
        border-right: 0 none;
        font-size: inherit;
    }

    .list-toc .list-group-item:first-child {
        border-top-right-radius: 0;
        border-top-left-radius: 0;
    }

    .list-toc .list-group-item:last-child {
        border-bottom-right-radius: 0;
        border-bottom-left-radius: 0;
    }

    /* Left navigation */
    .nav-left ul li a {
        padding-top: 3px;
        padding-bottom: 3px;
        border-left: 1px solid transparent;
    }

    .nav-left ul li.active a,
    .nav-left ul li a:hover {
        background: none !important;
        color: inherit;
        border-color: inherit;
    }

    .navbar-top {
        position: relative;
    }

    .affix {
        top: 60px;
    }

    .badge {
        border-radius: 4px;
        padding: 5px;
    }

    /* Footer Section */
    footer {
        color: black;
        background: white;
        width: 100%;
        position: absolute;
        bottom: 0;
    }

    footer #copyright {
        padding: 30px;
        text-align: center;
        color: #444;
    }

    footer #copyright p {
        margin: 0;
    }

    footer #copyright span a {
        color: white;
    }

    /* Top Navigation */
    @media (max-width: 767px) {
        ul.navbar-nav {
            margin: 0 -15px
        }

        ul.navbar-nav li {
            border-radius: 0;
        }

        ul.navbar-nav li ul {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 0;
            box-shadow: none;
            display: block;
            float: none;
            left: auto;
            padding: 0;
            position: static;
        }

        ul.navbar-nav li ul li a {
            padding: 8px 30px;
        }

        ul.navbar-nav li ul li ul li a {
            padding: 6px 40px;
        }
    }

    @media (min-width: 768px) {

        ul.navbar-nav li {
            display: block;
            position: relative;
            float: left;
        }

        ul.navbar-nav li ul {
            display: none;
        }

        ul.navbar-nav li a {
            display: block;
        }

        ul.navbar-nav li:hover > ul {
            display: block;
            position: absolute;
        }

        ul.navbar-nav li:hover li {
            float: none;
        }

        ul.navbar-nav ul ul {
            left: 100%;
            top: 0;
        }
    }
</style>
    <style>
    .prooph-logo {
            float: left;
            margin-left: 8px;
            margin-right: 8px;
            transition-timing-function: ease-in-out;
            transition: all 5s;
            height: 50px;
            padding: 5px;
        }

        .prooph-logo:hover {
            transition: all .7s;
            transition-timing-function: ease-out;
            transform: rotate(360deg);
        }
</style>
</head>
<body data-spy="scroll" data-target="#sideNav" data-offset="50" class="bbt-theme-cerulean">
<div class="page-wrapper">
    <header>
    
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="box-header container">
        <form class="form-search navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text"
                       placeholder="Search"
                       class="js-search-input form-control"
                       data-roothref="/">

                <div class="js-search-results"></div>
            </div>
        </form>

        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#js-navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://getprooph.org">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="prooph-logo">
                    <defs>
                        <style>
                            .cls-1{fill:#04a1b0;}.cls-2{fill:#26896c;}.cls-3{fill:#eeca50;}.cls-4{fill:#eb6842;}.cls-5{fill:#cc3340;}.cls-6{fill:#715671;}
                        </style>
                    </defs>
                    <title>prooph-logo</title>
                    <g id="artwork">
                        <g id="Layer_5" data-name="Layer 5">
                            <path class="cls-1"
                                  d="M57.22,17,67.84,35.43a1.77,1.77,0,0,0,1.53.89h61.25a1.77,1.77,0,0,0,1.53-.89L142.78,17a1.77,1.77,0,0,0-1.53-2.66H58.76A1.77,1.77,0,0,0,57.22,17Z"/>
                            <path class="cls-2"
                                  d="M29.54,94.68l30.63-53a1.77,1.77,0,0,0,0-1.77L49.55,21.48a1.77,1.77,0,0,0-3.07,0L5.24,92.91a1.77,1.77,0,0,0,1.53,2.66H28A1.77,1.77,0,0,0,29.54,94.68Z"/>
                            <path class="cls-3"
                                  d="M60.16,158.36l-30.63-53a1.77,1.77,0,0,0-1.53-.89H6.78a1.77,1.77,0,0,0-1.53,2.66l41.24,71.43a1.77,1.77,0,0,0,3.07,0l10.61-18.38A1.77,1.77,0,0,0,60.16,158.36Z"/>
                            <path class="cls-4"
                                  d="M130.63,163.68H69.37a1.77,1.77,0,0,0-1.53.89L57.22,183a1.77,1.77,0,0,0,1.53,2.66h82.48a1.77,1.77,0,0,0,1.53-2.66l-10.61-18.38A1.77,1.77,0,0,0,130.63,163.68Z"/>
                            <path class="cls-5"
                                  d="M170.46,105.32l-30.63,53a1.77,1.77,0,0,0,0,1.77l10.61,18.38a1.77,1.77,0,0,0,3.07,0l41.24-71.43a1.77,1.77,0,0,0-1.53-2.66H172A1.77,1.77,0,0,0,170.46,105.32Z"/>
                            <path class="cls-6"
                                  d="M139.84,41.64l30.63,53a1.77,1.77,0,0,0,1.53.89h21.23a1.77,1.77,0,0,0,1.53-2.66L153.52,21.48a1.77,1.77,0,0,0-3.07,0L139.84,39.86A1.77,1.77,0,0,0,139.84,41.64Z"/>
                        </g>
                    </g>
                </svg>
            </a>

        </div>

        <div class="collapse navbar-collapse" id="js-navbar-collapse">
            
    
    <ul class="nav navbar-nav">
                        <li>
    <a href="/tutorial/">Tutorial</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/tutorial/introduction.html">Introduction</a>

    </li>
                        <li>
    <a href="/tutorial/why_event_sourcing.html">Why Event Sourcing?</a>

    </li>
                        <li>
    <a href="/tutorial/event_sourcing_basics.html">Event Sourcing Basics</a>

    </li>
                        <li>
    <a href="/tutorial/testing_aggregates.html">Testing Aggregates</a>

    </li>
                        <li>
    <a href="/tutorial/aggregate_dependencies.html">Aggregate Dependencies</a>

    </li>
                        <li>
    <a href="/tutorial/process_managers.html">Process Managers</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/service-bus/">Service Bus</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/service-bus/intro.html">PSB - ProophServiceBus</a>

    </li>
                        <li>
    <a href="/service-bus/overview.html">PSB Overview</a>

    </li>
                        <li>
    <a href="/service-bus/message_bus.html">Message Buses</a>

    </li>
                        <li>
    <a href="/service-bus/plugins.html">PSB Plugins</a>

    </li>
                        <li>
    <a href="/service-bus/async_message_producer.html">Async Message Producer</a>

    </li>
                        <li>
    <a href="/service-bus/factories.html">Interop + Factories</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/event-store/">Event Store</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/event-store/intro.html">Prooph Event Store</a>

    </li>
                        <li>
    <a href="/event-store/event_store.html">Prooph Event Store</a>

    </li>
                        <li>
    <a href="/event-store/projections.html">Projections</a>

    </li>
                        <li>
    <a href="/event-store/upcasting.html">Upcasting</a>

    </li>
                        <li>
    <a href="/event-store/interop_factories.html">Interop Factories</a>

    </li>
                        <li>
    <a href="/event-store/migration.html">Migration from v6 to v7</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/event-sourcing/">Event Sourcing</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/event-sourcing/intro.html">ProophEventSourcing</a>

    </li>
                        <li>
    <a href="/event-sourcing/repositories.html">Working with Repositories</a>

    </li>
                        <li>
    <a href="/event-sourcing/snapshots.html">Snapshots</a>

    </li>
                        <li>
    <a href="/event-sourcing/inheritance.html">Inheritance with Aggregate Roots</a>

    </li>
                        <li>
    <a href="/event-sourcing/interop_factories.html">Interop Factories</a>

    </li>
                        <li>
    <a href="/event-sourcing/migration.html">Migration from v4 to v5</a>

    </li>
            </ul>

    </li>
            </ul>

        </div>
    </div>
</nav>
</header>
<div class="container">
    <ol class="breadcrumb">
                        <li><a href="/">prooph components documentation</a></li>
                                <li><a href="/tutorial/">Tutorial</a></li>
                                <li class="active">Aggregate Dependencies</li>
            </ol>
    <div class="row">

                <div class="col-md-3">
            <nav class="nav-left hidden-xs hidden-sm" id="sideNav">
    <ul class="nav nav-stacked" data-spy="affix" data-offset-top="59" role="tablist">
                                <li>
                <a href="#1-5" title="Aggregate&#x20;Dependencies">Aggregate Dependencies</a>
            </li>
                                <li>
                <a href="#1-5-1" title="Method&#x20;Injection">Method Injection</a>
            </li>
                                <li>
                <a href="#1-5-2" title="Be&#x20;Careful">Be Careful</a>
            </li>
                                <li>
                <a href="#1-5-3" title="Links">Links</a>
            </li>
            </ul>
</nav>
        </div>
                <div class="col-md-9">
<div id="section-main"><h1 id="1-5">Aggregate Dependencies</h1>
<p>In the previous chapters we've learned that an aggregate protects invariants and records an event for each state transition.
It then applies recorded events to its internal state and uses the state to validate if the next state transition can take place.</p>
<p>But not in all cases an aggregate can rely on its internal state only. Sometimes the aggregate needs to get information
from somewhere else to make a decision. In this case the aggregate has a dependency to an external service and in this
chapter we will learn how to give access to such a service and of course how to test it.</p>
<h2 id="1-5-1">Method Injection</h2>
<p>You may have noticed that we've left a <code>@TODO Check stock</code> in the <code>Basket::addProduct()</code> method. Products are handled
in an external ERP system and we can request current stock of a product from that system. When implementing Domain-Driven Design
it is a common approach to integrate an external system by defining an interface for it in the domain model but move
the implementation to the <code>infrastucture</code> layer. A good example of such an integration is shown in the PHP DDD Cargo Sample¹
where the Cargo domain makes use of an external GraphTraversalService. This is called Hexagonal Architecture or Ports &amp; Adapters².</p>
<p>We want to use the same approach for the ERP system but limit the implementation to the interface only as we don't have
access to the ERP system right now. We only know the interface specification. But that's enough because we can easily
mock the ERP and use the interface to decouple our domain model from it.</p>
<p><em>File: ./Basket/src/Model/ERP/ERP.php</em></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Basket\Model\ERP;

use App\Basket\Model\Exception\UnknownProduct;

interface ERP
{
    /**
     * Get stock information of given product
     *
     * If stock information cannot be fetched from the ERP system
     * this method returns null.
     *
     * If product is not known by the ERP system this method must throw an UnknownProduct exception
     *
     * @param ProductId $productId
     * @return ProductStock|null
     * @throws UnknownProduct
     */
    public function getProductStock(ProductId $productId): ?ProductStock;
}


</code></pre>
<p>As you can see the <code>ERP</code> interface defines a method <code>getProductStock</code> which takes a <code>ProductId</code> as argument and returns a
<code>ProductStock</code> value object or null in case the request failed. You may have noticed that we use value objects a lot. In fact everything except our <code>Basket</code>
aggregate is modeled as a value object so far. It is a rule of thumb to model everything as value objects and only
use an aggregate if the object really has a lifecycle in YOUR domain. Products of course have a lifecycle but in
the ERP system and not in our basket domain. We only consume product data as read-only information. Hence, we are better
of with using value objects to represent different aspects of a product like its stock information.</p>
<p>Having said this, let's add the value object.</p>
<p><em>File: ./Basket/src/Model/ERP/ProductStock.php</em></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Basket\Model\ERP;

final class ProductStock
{
    /**
     * @var ProductId
     */
    private $productId;

    /**
     * @var int
     */
    private $quantity;

    /**
     * @var int
     */
    private $version;

    public static function fromArray(array $data): self
    {
        return new self(
            ProductId::fromString($data['product_id'] ?? ''),
            $data['quantity'] ?? 0,
            $data['version'] ?? 0
        );
    }

    private function __construct(ProductId $productId, int $quantity, int $version)
    {
        $this-&gt;productId = $productId;
        $this-&gt;quantity = $quantity;
        $this-&gt;version = $version;
    }

    /**
     * @return ProductId
     */
    public function productId(): ProductId
    {
        return $this-&gt;productId;
    }

    /**
     * @return int
     */
    public function quantity(): int
    {
        return $this-&gt;quantity;
    }

    /**
     * @return int
     */
    public function version(): int
    {
        return $this-&gt;version;
    }

    public function toArray(): array
    {
        return [
            'product_id' =&gt; $this-&gt;productId-&gt;toString(),
            'quantity' =&gt; $this-&gt;quantity,
            'version' =&gt; $this-&gt;version
        ];
    }

    public function equals($other): bool
    {
        if(!$other instanceof self) {
            return false;
        }

        return $this-&gt;toArray() === $other-&gt;toArray();
    }

    public function __toString(): string
    {
        return json_encode($this-&gt;toArray());
    }
}

</code></pre>
<p><code>ProductStock</code> gives us two important information:</p>
<ul>
<li>stock quantity</li>
<li>a version</li>
</ul>
<p>Stock quantity is self-explaining and the version is related to that quantity. Whenever stock quantity of a product
changes the version is increased by one. We can use the version during checkout to verify if the last known quantity of
the product is still valid or if the quantity known by the basket is out-of-date.</p>
<p>We also need a new <code>UnknownProduct</code> exception which is thrown by the <code>ERP</code> adapter in case the ERP system returns a not found response.</p>
<p><em>File: ./Basket/src/Model/Exception/UnknownProduct.php</em></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Basket\Model\Exception;

use App\Basket\Model\ERP\ProductId;

final class UnknownProduct extends \InvalidArgumentException
{
    public static function withProductId(ProductId $productId): self
    {
        return new self(sprintf(
            'Product with %s is unknown.',
            $productId-&gt;toString()
        ));
    }
}

</code></pre>
<p>Now the <code>Basket</code> aggregate should use the <code>ERP</code> system to request stock information before adding a product to the basket.
The aggregate should reject the product if it is out of stock.</p>
<p><em>Note: We keep the example simple. In a real world system this stock check would include many more variants for example permanent or
temporarily out of stock products, checkout even if a product is out of stock, and so on.</em></p>
<p>But how do we get the <code>ERP</code> adapter into the aggregate? The answer is <strong>Method Injection</strong>. The <code>Basket::addProduct</code> defines
the <code>ÈRP</code> system as a dependency for that method. The caller of the method is responsible for providing an implementation.
We see that in action when we look at command handlers. For now we align the method and update our test case.</p>
<p><em>File: ./Basket/src/Model/Basket.php</em></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Basket\Model;

//...
use App\Basket\Model\ERP\ERP;
use App\Basket\Model\Exception\ProductOutOfStock;

final class Basket extends AggregateRoot
{
    //...
    
    public function addProduct(ProductId $productId, ERP $ERP): void
    {
        if(array_key_exists($productId-&gt;toString(), $this-&gt;products)) {
            throw ProductAddedTwice::toBasket($this-&gt;basketId, $productId);
        }

        //If the ERP system does not know the product an exception will be thrown here
        //which will stop the operation. The aggregate can not deal with that situation
        //as this is one of these "this should never happen" situations
        //If we want an unbreakable domain model we would need to talk to the business
        //and work out a failover plan triggered by a UnknownProductAddedToBasket event.
        $productStock = $ERP-&gt;getProductStock($productId);

        if(!$productStock) {
            $this-&gt;recordThat(ProductAddedToBasket::occur($this-&gt;basketId-&gt;toString(), [
                    'product_id' =&gt; $productId-&gt;toString(),
                    //If we did not get a response, we add the product and check stock later again
                    //the shopping session should not be blocked by a temporarily unavailable ERP system
                    'stock_version' =&gt; null,
                    'stock_quantity'=&gt; null,
                    'quantity' =&gt; 1,
            ]));
            return;
        }

        if($productStock-&gt;quantity() === 0) {
            throw ProductOutOfStock::withProductId($productId);
        }

        $this-&gt;recordThat(ProductAddedToBasket::occur($this-&gt;basketId-&gt;toString(), [
            'product_id' =&gt; $productId-&gt;toString(),
            'stock_version' =&gt; $productStock-&gt;version(),
            'stock_quantity' =&gt; $productStock-&gt;quantity(),
            'quantity' =&gt; 1,
        ]));
    }

    /**
     * Apply given event
     */
    protected function apply(AggregateChanged $event): void
    {
        switch ($event-&gt;messageName()) {
            case ShoppingSessionStarted::class:
                //...
            case ProductAddedToBasket::class:
                /** @var $event ProductAddedToBasket */

                //Use ProductId as index to avoid adding a product twice
                $this-&gt;products[$event-&gt;productId()-&gt;toString()] = [
                    'stock_quantity' =&gt; $event-&gt;stockQuantity(),
                    'stock_version' =&gt; $event-&gt;stockVersion(),
                    'quantity' =&gt; $event-&gt;quantity()
                ];
                break;
        }
    }
}

</code></pre>
<p><code>Basket::addProduct()</code> has quite some logic now and uses an external <code>ERP</code> system to request stock information of the product.
In case the ERP system is temporarily unavailable the <code>Basket</code> aggregate accepts the product without a stock quantity
check. Later in the checkout process we need to take care of this situation and check stock again. If we have
a quantity stock conflict during checkout the order is routed to a support team who needs to contact the customer and
offer an alternative.</p>
<p>If we got stock information from the ERP system we check quantity and throw a <code>ProductOutOfStock</code> exception if it is zero.</p>
<p><em>File: ./Basket/src/Model/Exception/ProductOutOfStock.php</em></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Basket\Model\Exception;

use App\Basket\Model\ERP\ProductId;

final class ProductOutOfStock extends \RuntimeException
{
    public static function withProductId(ProductId $productId): self
    {
        return new self(sprintf(
            'Product with %s is out of stock.',
            $productId-&gt;toString()
        ));
    }
}

</code></pre>
<p>If everything is ok the <code>Basket</code> aggregate accepts the product and records the <code>ProductAddedToBasket</code> event but now
with additional information so we need to add new getter methods to the event.</p>
<p><em>File: ./Baset/src/Model/Event/ProductAddedToBasket.php</em></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\Basket\Model\Event;

use App\Basket\Model\Basket\BasketId;
use App\Basket\Model\ERP\ProductId;
use Prooph\EventSourcing\AggregateChanged;

final class ProductAddedToBasket extends AggregateChanged
{
    public function basketId(): BasketId
    {
        return BasketId::fromString($this-&gt;aggregateId());
    }

    public function productId(): ProductId
    {
        return ProductId::fromString($this-&gt;payload()['product_id']);
    }

    public function stockQuantity(): ?int
    {
        return $this-&gt;payload()['stock_quantity'];
    }

    public function stockVersion(): ?int
    {
        return $this-&gt;payload()['stock_version'];
    }

    public function quantity(): int
    {
        return $this-&gt;payload()['quantity'];
    }
}

</code></pre>
<p>In the <code>apply</code> method of the <code>Basket</code> aggregate these additional information is added to the internal state
so that we have access to it later.</p>
<p>Testing the expanded version of <code>Basket::addProduct()</code> is still relatively simple but we end up with a lot more test methods
to cover the different results of the method call. Check the additions below and see how we can use PHPUnit's <code>prophecy</code>
integration to mock the ERP system and simulate different situations.</p>
<p><em>File: ./Basket/tests/Model/BasketTest.php</em></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace App\BasketTest\Model;

use App\Basket\Model\Basket;
use App\Basket\Model\ERP\ERP;
use App\Basket\Model\ERP\ProductId;
use App\Basket\Model\ERP\ProductStock;
use App\Basket\Model\Event\ProductAddedToBasket;
use App\Basket\Model\Event\ShoppingSessionStarted;
use App\Basket\Model\Basket\BasketId;
use App\Basket\Model\Basket\ShoppingSession;
use App\Basket\Model\Exception\UnknownProduct;
use App\BasketTest\TestCase;
use Prooph\EventSourcing\AggregateChanged;
use Prophecy\Argument;
use Ramsey\Uuid\Uuid;

class BasketTest extends TestCase
{
    /**
     * @var ShoppingSession
     */
    private $shoppingSession;

    /**
     * @var BasketId
     */
    private $basketId;

    /**
     * @var ProductId
     */
    private $product1;

    protected function setUp()
    {
        $this-&gt;shoppingSession = ShoppingSession::fromString('123');
        $this-&gt;basketId = BasketId::fromString(Uuid::uuid4()-&gt;toString());
        $this-&gt;product1 = ProductId::fromString('A1');
    }

    /**
     * @test
     */
    public function it_starts_a_shopping_session()
    {
        $basket = Basket::startShoppingSession($this-&gt;shoppingSession, $this-&gt;basketId);

        /** @var AggregateChanged[] $events */
        $events = $this-&gt;popRecordedEvents($basket);

        $this-&gt;assertCount(1, $events);

        /** @var ShoppingSessionStarted $event */
        $event = $events[0];

        $this-&gt;assertSame(ShoppingSessionStarted::class, $event-&gt;messageName());
        $this-&gt;assertTrue($this-&gt;basketId-&gt;equals($event-&gt;basketId()));
        $this-&gt;assertTrue($this-&gt;shoppingSession-&gt;equals($event-&gt;shoppingSession()));
    }

    /**
     * @test
     */
    public function it_adds_a_product_if_stock_quantity_is_greater_than_zero()
    {
        $basket = $this-&gt;reconstituteBasketFromHistory(
            $this-&gt;shoppingSessionStarted()
        );

        $basket-&gt;addProduct($this-&gt;product1, $this-&gt;product1ERP());

        /** @var AggregateChanged[] $events */
        $events = $this-&gt;popRecordedEvents($basket);

        $this-&gt;assertCount(1, $events);

        /** @var ProductAddedToBasket $event */
        $event = $events[0];

        $this-&gt;assertSame(ProductAddedToBasket::class, $event-&gt;messageName());
        $this-&gt;assertTrue($this-&gt;basketId-&gt;equals($event-&gt;basketId()));
        $this-&gt;assertTrue($this-&gt;product1-&gt;equals($event-&gt;productId()));
        $this-&gt;assertSame(5, $event-&gt;payload()['stock_quantity']);
        $this-&gt;assertSame(1, $event-&gt;payload()['stock_version']);
        $this-&gt;assertSame(1, $event-&gt;payload()['quantity']);
    }

    /**
     * @test
     * @expectedException \App\Basket\Model\Exception\ProductAddedTwice
     */
    public function it_throws_exception_if_product_is_added_twice()
    {
        $basket = $this-&gt;reconstituteBasketFromHistory(
            $this-&gt;shoppingSessionStarted(),
            $this-&gt;product1Added()
        );

        //Add same product again
        $basket-&gt;addProduct($this-&gt;product1, $this-&gt;product1ERP());
    }

    /**
     * @test
     * @expectedException \App\Basket\Model\Exception\UnknownProduct
     */
    public function it_stops_operation_if_product_is_unknown()
    {
        $basket = $this-&gt;reconstituteBasketFromHistory(
            $this-&gt;shoppingSessionStarted()
        );

        $ERP = $this-&gt;prophesize(ERP::class);

        //This ERP mock knows no product
        $ERP-&gt;getProductStock(Argument::any())-&gt;willThrow(UnknownProduct::withProductId($this-&gt;product1));

        $basket-&gt;addProduct($this-&gt;product1, $ERP-&gt;reveal());
    }

    /**
     * @test
     */
    public function it_adds_product_without_stock_info_if_ERP_is_unavailable()
    {
        $basket = $this-&gt;reconstituteBasketFromHistory(
            $this-&gt;shoppingSessionStarted()
        );

        $ERP = $this-&gt;prophesize(ERP::class);

        //This ERP is unavailable
        $ERP-&gt;getProductStock(Argument::any())-&gt;willReturn(null);

        $basket-&gt;addProduct($this-&gt;product1, $ERP-&gt;reveal());

        /** @var AggregateChanged[] $events */
        $events = $this-&gt;popRecordedEvents($basket);

        $this-&gt;assertCount(1, $events);

        /** @var ProductAddedToBasket $event */
        $event = $events[0];

        $this-&gt;assertSame(ProductAddedToBasket::class, $event-&gt;messageName());
        $this-&gt;assertTrue($this-&gt;basketId-&gt;equals($event-&gt;basketId()));
        $this-&gt;assertTrue($this-&gt;product1-&gt;equals($event-&gt;productId()));
        $this-&gt;assertSame(1, $event-&gt;payload()['quantity']);
        //No stock info present
        $this-&gt;assertSame(null, $event-&gt;payload()['stock_quantity']);
        $this-&gt;assertSame(null, $event-&gt;payload()['stock_version']);
    }

    /**
     * @test
     * @expectedException \App\Basket\Model\Exception\ProductOutOfStock
     */
    public function it_does_not_add_product_if_product_is_out_of_stock()
    {
        $basket = $this-&gt;reconstituteBasketFromHistory(
            $this-&gt;shoppingSessionStarted()
        );

        //Set stock quantity to zero in the ERP mock
        $basket-&gt;addProduct($this-&gt;product1, $this-&gt;product1ERP(0));
    }

    /**
     * Helper method to reconstitute a Basket from history
     *
     * With this helper we get better type hinting in the test methods
     * because type hint for reconstituteAggregateFromHistory() is only AggregateRoot
     *
     * @param AggregateChanged[] ...$events
     * @return Basket
     */
    private function reconstituteBasketFromHistory(AggregateChanged ...$events): Basket
    {
        return $this-&gt;reconstituteAggregateFromHistory(
            Basket::class,
            $events
        );
    }

    /**
     * Test helper to create a ShoppingSessionStarted event
     *
     * If we need to change signature of the event later, we have a central place in the test case
     * where we can align the creation.
     *
     * @return ShoppingSessionStarted
     */
    private function shoppingSessionStarted(): ShoppingSessionStarted
    {
        return ShoppingSessionStarted::occur($this-&gt;basketId-&gt;toString(), [
            'shopping_session' =&gt; $this-&gt;shoppingSession-&gt;toString()
        ]);
    }

    /**
     * Test helper to create a ProductAddedToBasket event
     *
     * If we need to change signature of the event later, we have a central place in the test case
     * where we can align the creation.
     *
     * @return ProductAddedToBasket
     */
    private function product1Added(): ProductAddedToBasket
    {
        return ProductAddedToBasket::occur($this-&gt;basketId-&gt;toString(), [
            'product_id' =&gt; $this-&gt;product1-&gt;toString(),
            'stock_quantity' =&gt; 5,
            'stock_version' =&gt; 1,
            'quantity' =&gt; 1,
        ]);
    }

    private function product1ERP(int $stockQuantity = 5): ERP
    {
        //Create a Mock of the ERP interface
        $ERP = $this-&gt;prophesize(ERP::class);

        $ERP-&gt;getProductStock(Argument::exact($this-&gt;product1))-&gt;willReturn(ProductStock::fromArray(
            [
                'product_id' =&gt; $this-&gt;product1-&gt;toString(),
                'quantity' =&gt; $stockQuantity,
                'version' =&gt; 1
            ]
        ));

        return $ERP-&gt;reveal();
    }
}

</code></pre>
<pre><code class="language-bash">$ php vendor/bin/phpunit

PHPUnit 6.3.1 by Sebastian Bergmann and contributors.
......                                                              6 / 6 (100%)

Time: 27 ms, Memory: 4.00MB

OK (6 tests, 21 assertions)

</code></pre>
<h2 id="1-5-2">Be Careful</h2>
<p>You need to be careful when Using a dependency insight of an aggregate method. In the example shown above we only
read data from an external system and we can handle the cases when communication goes wrong be it that the product
could not be found or the external system is unavailable.</p>
<p>Things get even more complex when you want to write data to an external system. Let's say we want to update stock quantity
for a product instead of requesting it. Such write operations should not be performed by the aggregate itself but instead
by a process manager or a saga. In the next two chapters we're going to learn more about process managers and sagas
and the difference between the two.</p>
<h2 id="1-5-3">Links</h2>
<ul>
<li>
<a href="https://github.com/codeliner/php-ddd-cargo-sample">PHP DDD Cargo Sample</a>¹</li>
<li>
<a href="http://alistair.cockburn.us/Hexagonal+architecture">Hexagonal Architecture</a>²</li>
</ul>
</div>        </div>
    </div>
</div>

<footer>
    <div class="links">
        <div class="container">
            <div class="row">
                <div class="prev col-xs-6">
                                            <a href="/tutorial/testing_aggregates.html">Previous</a>                                    </div>
                <div class="next col-xs-6">
                                            <a href="/tutorial/process_managers.html">Next</a>                                    </div>
            </div>
        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>Powered by <a href="https://github.com/tobiju/bookdown-bootswatch-templates" title="Visit project to generate your own docs">Bookdown Bootswatch Templates</a>.</p>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
<a href="https://github.com/prooph/proophessor"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="http://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
<script src="https://tobiju.github.io/share/prismjs/main.js"></script>
<script src="https://tobiju.github.io/share/prismjs/prism.js"></script>
<script type="text/javascript">

    function Search() {
        this.store = {};
        this.index = lunr(function () {
            this.ref('id');
            this.field('title', {boost: 10});
            this.field('content');
        });
        this.searchResults = $('.js-search-results').addClass('list-search-results');
    }

    Search.prototype = {
        constructor: Search,
        init: function () {
            this.createIndex();
            this.bindEvents();
        },
        createIndex: function () {
            var $this = this,
                indexFilePath = $('.js-search-input').data('roothref') + 'index.json';

            $.getJSON(indexFilePath, function (data) {
                $.each(data, function (key, item) {
                    $this.index.add({
                        id: item.id,
                        title: item.title,
                        content: item.content
                    });

                    $this.store[item.id] = {
                        href: item.id,
                        title: item.title,
                        content: item.content
                    }
                });
            });
        },
        bindEvents: function () {
            var $this = this;

            $('html')
                .on('click', function (event) {
                    $this.close($(this), event);
                });

            $('.js-search-input, .js-search-results')
                .on('click', function (event) {
                    $this.click($(this), event);
                });

            $('.js-search-input')
                .on('focus', function (event) {
                    $this.focus($(this), event);
                })
                .on('keyup', function (event) {
                    $this.search($(this), event)
                })
                .on('keydown', function (event) {
                    if ($('.js-search-results ul').is(':visible')){
                        $this.navigation($(this), event)
                    }
                })
        },
        click: function (element, event) {
            event.stopPropagation();
        },
        focus: function (element, event) {
            this.searchInputWidth = element.css('width');
            element.animate({
                'width': 600
            }, 500);
            $('#js-navbar-collapse > ul').fadeOut();
        },
        close: function (element, event) {
            var $this = this;

            $('.js-search-results').hide();
            $('.js-search-input').animate({
                'width': $this.searchInputWidth
            }, 500);
            $('#js-navbar-collapse > ul').fadeIn();
        },
        search: function (element, event) {
            var $this = this;

            if (event.keyCode == 13 || event.keyCode == 38 || event.keyCode == 40) {
                return;
            }

            var query = element.val(),
                results = $this.index.search(query);

            if (!results.length) {
                $this.searchResults.empty();
                return;
            }

            var resultsList = results.reduce(function (ul, result) {
                var item = $this.store[result.ref];
                var title = $('<b>').text(item.title);

                var cropText = $this.cropText(item.content, query);
                if (cropText.length === 0) {
                    cropText = $('<p>').html(item.content.substring(0, 120) + "...");
                }
                var content = content = $('<p>').html(cropText);

                var div = $('<div>')
                    .append(title)
                    .append(content);
                var a = $('<a>').attr('href', item.href)
                    .append(div);
                var li = $('<li>')
                    .append(a);
                ul.append(li);

                return ul;
            }, $('<ul>'));

            this.searchResults.html(resultsList);

            $('.js-search-results').show();
            $(".js-search-results li:first-child").addClass('selected');
        },
        cropText: function (content, query) {
            var cropedText = '',
                re = new RegExp("\\s?(.{0,30})?" + query + ".*?\\b(.{0,30}.)?\\s?", "gi");

            $.each(content.match(re), function (key, value) {
                cropedText += '...' + value + '...';
            });

            return cropedText;
        },
        navigation: function (element, event) {
            var selected = null,
                listSelector = ".js-search-results ul",
                listItemSelector = listSelector + " li",
                selectedListItemSelector = listItemSelector + ".selected",
                selectedListItemSelectorAnchor = listItemSelector + ".selected a";

            // enter
            if (event.keyCode == 13) {
                event.preventDefault();
                this.close();
                window.location.replace($(selectedListItemSelectorAnchor).attr('href'));
            }

            // up
            if (event.keyCode == 38) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.prev().length == 0) {
                    selected.siblings().last().addClass("selected");
                } else {
                    selected.prev().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListUp(selected);
            }

            // down
            if (event.keyCode == 40) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.next().length == 0) {
                    selected.siblings().first().addClass("selected");
                } else {
                    selected.next().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListDown(selected);
            }
        },
        scrollListDown: function (element) {
            var ul = element.parent(),
                ulHeight = ul.height(),
                ulBottomPosition = ulHeight + ul.scrollTop(),
                liBottomPosition = element.position().top + element.height();

            if (liBottomPosition > ulBottomPosition) {
                ul.scrollTop(liBottomPosition - ulHeight);
            }

            if (element.is(':first-child')) {
                ul.scrollTop(0);
            }
        },
        scrollListUp: function (element) {
            var ul = element.parent(),
                ulTopPosition = ul.scrollTop(),
                liTopPosition = element.position().top;

            if (liTopPosition < ulTopPosition) {
                ul.scrollTop(element.position().top);
            }

            if (element.is(':last-child')) {
                ul.scrollTop(element.position().top - element.height());
            }
        }
    };

    $(function () {
        var search = new Search();
        search.init();
    });
</script>
</body></html>
