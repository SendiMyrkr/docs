
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<meta name="HandheldFriendly" content="True"/>
<title>Introduction</title>
<link rel="shortcut icon" href="http://getprooph.org/images/ico/prooph-logo@0.5x.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://getprooph.org/images/ico/apple-touch-icon-144-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://getprooph.org/images/ico/apple-touch-icon-114-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://getprooph.org/images/ico/apple-touch-icon-72-precomposed.png">
<link rel="apple-touch-icon-precomposed" href="http://getprooph.org/images/ico/apple-touch-icon-57-precomposed.png">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@prooph_software">
<meta name="twitter:title" content="prooph components">
<meta name="twitter:description" content="Enterprise-ready CQRS and Event Sourcing packages for PHP with support for the most famous PHP web frameworks">
<meta name="twitter:image" content="http://getprooph.org/images/prooph-components-intro.png">
    <link rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.5/cerulean/bootstrap.min.css">
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-ghcolors.css"/>
<link rel="stylesheet"
      href="https://tobiju.github.io/share/prismjs/prism-linenumbers.css"/>
<style>
    body, html {
        height: 100%;
        padding-top: 36px;
        position: relative;
    }

    img {
        max-width: 100%;
    }

    code span {
        white-space: nowrap;
    }
    code span.comment {
        white-space: pre;
    }

    .highlight {
        background: #FFFF88;
    }

    .page-wrapper {
        min-height: 100%;
        padding-bottom: 170px;
        position: relative;
    }

    .box-header {
        position: relative;
    }

    /* Header Section */
    header {
        background: white;
        color: black;
        font-size: 16px;
        font-weight: 300;
    }

    h1:first-child {
        margin-top: 0;
    }

    /* anchor link will be displayed after the static top nav */
    h1:before,
    h2:before,
    h3:before,
    h4:before,
    h5:before,
    h6:before {
        display: block;
        content: " ";
        margin-top: -64px;
        height: 64px;
        visibility: hidden;
    }

    .navbar-brand {
        padding: 0;
    }

    .navbar-brand img {
        max-height: 100%;
    }

    /* Content Section */
    #content {
        margin-bottom: 17px;
        font-size: 17px;
        min-height: 200px;
    }

    .breadcrumb {
        position: relative;
        z-index: 999;
    }

    .links {
        background: #f8f8f8;
        border-top: 1px solid #e5e5e5;
        border-bottom: 1px solid #e5e5e5;
        padding: 16px 0;
    }

    .links .prev {
        text-align: left;
    }

    .links .parent {
        text-align: center;
    }

    .links .next {
        text-align: right;
    }

    /* Search */
    .form-search {
        position: absolute;
        right: 0;
        top: 0;
        z-index: 999;
    }

    @media (max-width: 767px) {
        .form-search {
            position: relative;
            margin-top: 0;
        }
    }

    .form-search .form-control {
        border: 0;
        width: 80px;
    }

    @media (max-width: 767px) {
        .form-search .form-control {
            width: 100% !important;
        }
    }

    .form-search .list-search-results {
        position: relative;
    }

    .form-search .list-search-results ul {
        background: #eee;
        border: 1px solid inherit;
        list-style: none;
        max-height: 300px;
        overflow: auto;
        padding: 0;
        position: absolute;
        width: 100%;
        z-index: 999;
    }

    .form-search .list-search-results ul li:nth-child(even) {
        background: rgba(255, 255, 255, 0.3)
    }

    .form-search .list-search-results ul li.selected {
        background: #ccc;
    }

    .form-search .list-search-results ul li a {
        display: block;
        padding: 4px 8px;
    }

    /* TOC */
    .list-toc {
        padding: 0;
    }

    .list-toc .list-group-item {
        background: 0 none;
        position: relative;
        font-weight: bold;
        padding: 0;
        margin: 0;
    }

    .list-toc li .text-number {
        padding-left: 20px;
    }
    .list-toc li li .text-number {
        padding-left: 40px;
    }
    .list-toc li li li .text-number {
        padding-left: 60px;
    }
    .list-toc li li li li .text-number {
        padding-left: 80px;
    }
    .list-toc li li li li li .text-number {
        padding-left: 100px;
    }
    .list-toc .text-number {
        padding-left: 100px;
    }

    .list-toc .list-group-item .row {
        padding: 7px 0 7px;
    }

    .list-toc .list-group-item .bbt-toc-toggle {
        display: block;
        position: absolute;
        top: 5px;
        right: 10px;
        font-weight: normal;
    }

    .list-toc .list-group-item .bbt-toc-toggle:before {
        content: "";
        display: block;
    }

    .list-toc .list-group-item .bbt-toc-toggle.collapsed:before {
        content: "";
        display: block;
    }

    .list-toc > li:nth-child(2n+1) {
        background: rgba(0, 0, 0, 0.03);
    }

    .bbt-theme-cyborg .list-toc > li:nth-child(2n+1),
    .bbt-theme-darkly .list-toc > li:nth-child(2n+1),
    .bbt-theme-slate .list-toc > li:nth-child(2n+1),
    .bbt-theme-superhero .list-toc > li:nth-child(2n+1) {
        background: rgba(255, 255, 255, 0.05);
    }

    .list-toc .list-group-item {
        border-bottom: 0 none;
        border-left: 0 none;
        border-right: 0 none;
        font-size: inherit;
    }

    .list-toc .list-group-item:first-child {
        border-top-right-radius: 0;
        border-top-left-radius: 0;
    }

    .list-toc .list-group-item:last-child {
        border-bottom-right-radius: 0;
        border-bottom-left-radius: 0;
    }

    /* Left navigation */
    .nav-left ul li a {
        padding-top: 3px;
        padding-bottom: 3px;
        border-left: 1px solid transparent;
    }

    .nav-left ul li.active a,
    .nav-left ul li a:hover {
        background: none !important;
        color: inherit;
        border-color: inherit;
    }

    .navbar-top {
        position: relative;
    }

    .affix {
        top: 60px;
    }

    .badge {
        border-radius: 4px;
        padding: 5px;
    }

    /* Footer Section */
    footer {
        color: black;
        background: white;
        width: 100%;
        position: absolute;
        bottom: 0;
    }

    footer #copyright {
        padding: 30px;
        text-align: center;
        color: #444;
    }

    footer #copyright p {
        margin: 0;
    }

    footer #copyright span a {
        color: white;
    }

    /* Top Navigation */
    @media (max-width: 767px) {
        ul.navbar-nav {
            margin: 0 -15px
        }

        ul.navbar-nav li {
            border-radius: 0;
        }

        ul.navbar-nav li ul {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 0;
            box-shadow: none;
            display: block;
            float: none;
            left: auto;
            padding: 0;
            position: static;
        }

        ul.navbar-nav li ul li a {
            padding: 8px 30px;
        }

        ul.navbar-nav li ul li ul li a {
            padding: 6px 40px;
        }
    }

    @media (min-width: 768px) {

        ul.navbar-nav li {
            display: block;
            position: relative;
            float: left;
        }

        ul.navbar-nav li ul {
            display: none;
        }

        ul.navbar-nav li a {
            display: block;
        }

        ul.navbar-nav li:hover > ul {
            display: block;
            position: absolute;
        }

        ul.navbar-nav li:hover li {
            float: none;
        }

        ul.navbar-nav ul ul {
            left: 100%;
            top: 0;
        }
    }
</style>
    <style>
    .prooph-logo {
            float: left;
            margin-left: 8px;
            margin-right: 8px;
            transition-timing-function: ease-in-out;
            transition: all 5s;
            height: 50px;
            padding: 5px;
        }

        .prooph-logo:hover {
            transition: all .7s;
            transition-timing-function: ease-out;
            transform: rotate(360deg);
        }
</style>
</head>
<body data-spy="scroll" data-target="#sideNav" data-offset="50" class="bbt-theme-cerulean">
<div class="page-wrapper">
    <header>
    
<nav class="navbar navbar-default navbar-fixed-top">
    <div class="box-header container">
        <form class="form-search navbar-form navbar-right" role="search">
            <div class="form-group">
                <input type="text"
                       placeholder="Search"
                       class="js-search-input form-control"
                       data-roothref="/">

                <div class="js-search-results"></div>
            </div>
        </form>

        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#js-navbar-collapse" aria-expanded="false">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="http://getprooph.org">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="prooph-logo">
                    <defs>
                        <style>
                            .cls-1{fill:#04a1b0;}.cls-2{fill:#26896c;}.cls-3{fill:#eeca50;}.cls-4{fill:#eb6842;}.cls-5{fill:#cc3340;}.cls-6{fill:#715671;}
                        </style>
                    </defs>
                    <title>prooph-logo</title>
                    <g id="artwork">
                        <g id="Layer_5" data-name="Layer 5">
                            <path class="cls-1"
                                  d="M57.22,17,67.84,35.43a1.77,1.77,0,0,0,1.53.89h61.25a1.77,1.77,0,0,0,1.53-.89L142.78,17a1.77,1.77,0,0,0-1.53-2.66H58.76A1.77,1.77,0,0,0,57.22,17Z"/>
                            <path class="cls-2"
                                  d="M29.54,94.68l30.63-53a1.77,1.77,0,0,0,0-1.77L49.55,21.48a1.77,1.77,0,0,0-3.07,0L5.24,92.91a1.77,1.77,0,0,0,1.53,2.66H28A1.77,1.77,0,0,0,29.54,94.68Z"/>
                            <path class="cls-3"
                                  d="M60.16,158.36l-30.63-53a1.77,1.77,0,0,0-1.53-.89H6.78a1.77,1.77,0,0,0-1.53,2.66l41.24,71.43a1.77,1.77,0,0,0,3.07,0l10.61-18.38A1.77,1.77,0,0,0,60.16,158.36Z"/>
                            <path class="cls-4"
                                  d="M130.63,163.68H69.37a1.77,1.77,0,0,0-1.53.89L57.22,183a1.77,1.77,0,0,0,1.53,2.66h82.48a1.77,1.77,0,0,0,1.53-2.66l-10.61-18.38A1.77,1.77,0,0,0,130.63,163.68Z"/>
                            <path class="cls-5"
                                  d="M170.46,105.32l-30.63,53a1.77,1.77,0,0,0,0,1.77l10.61,18.38a1.77,1.77,0,0,0,3.07,0l41.24-71.43a1.77,1.77,0,0,0-1.53-2.66H172A1.77,1.77,0,0,0,170.46,105.32Z"/>
                            <path class="cls-6"
                                  d="M139.84,41.64l30.63,53a1.77,1.77,0,0,0,1.53.89h21.23a1.77,1.77,0,0,0,1.53-2.66L153.52,21.48a1.77,1.77,0,0,0-3.07,0L139.84,39.86A1.77,1.77,0,0,0,139.84,41.64Z"/>
                        </g>
                    </g>
                </svg>
            </a>

        </div>

        <div class="collapse navbar-collapse" id="js-navbar-collapse">
            
    
    <ul class="nav navbar-nav">
                        <li>
    <a href="/tutorial/">Tutorial</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/tutorial/introduction.html">Introduction</a>

    </li>
                        <li>
    <a href="/tutorial/why_event_sourcing.html">Why Event Sourcing?</a>

    </li>
                        <li>
    <a href="/tutorial/event_sourcing_basics.html">Event Sourcing Basics</a>

    </li>
                        <li>
    <a href="/tutorial/testing_aggregates.html">Testing Aggregates</a>

    </li>
                        <li>
    <a href="/tutorial/aggregate_dependencies.html">Aggregate Dependencies</a>

    </li>
                        <li>
    <a href="/tutorial/process_managers.html">Process Managers</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/service-bus/">Service Bus</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/service-bus/intro.html">PSB - ProophServiceBus</a>

    </li>
                        <li>
    <a href="/service-bus/overview.html">PSB Overview</a>

    </li>
                        <li>
    <a href="/service-bus/message_bus.html">Message Buses</a>

    </li>
                        <li>
    <a href="/service-bus/plugins.html">PSB Plugins</a>

    </li>
                        <li>
    <a href="/service-bus/async_message_producer.html">Async Message Producer</a>

    </li>
                        <li>
    <a href="/service-bus/factories.html">Interop + Factories</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/event-store/">Event Store</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/event-store/intro.html">Prooph Event Store</a>

    </li>
                        <li>
    <a href="/event-store/event_store.html">Prooph Event Store</a>

    </li>
                        <li>
    <a href="/event-store/projections.html">Projections</a>

    </li>
                        <li>
    <a href="/event-store/upcasting.html">Upcasting</a>

    </li>
                        <li>
    <a href="/event-store/interop_factories.html">Interop Factories</a>

    </li>
                        <li>
    <a href="/event-store/migration.html">Migration from v6 to v7</a>

    </li>
            </ul>

    </li>
                        <li>
    <a href="/event-sourcing/">Event Sourcing</a>
    
    <ul class="dropdown-menu">
                        <li>
    <a href="/event-sourcing/intro.html">ProophEventSourcing</a>

    </li>
                        <li>
    <a href="/event-sourcing/repositories.html">Working with Repositories</a>

    </li>
                        <li>
    <a href="/event-sourcing/snapshots.html">Snapshots</a>

    </li>
                        <li>
    <a href="/event-sourcing/inheritance.html">Inheritance with Aggregate Roots</a>

    </li>
                        <li>
    <a href="/event-sourcing/interop_factories.html">Interop Factories</a>

    </li>
                        <li>
    <a href="/event-sourcing/migration.html">Migration from v4 to v5</a>

    </li>
            </ul>

    </li>
            </ul>

        </div>
    </div>
</nav>
</header>
<div class="container">
    <ol class="breadcrumb">
                        <li><a href="/">prooph components documentation</a></li>
                                <li><a href="/tutorial/">Tutorial</a></li>
                                <li class="active">Introduction</li>
            </ol>
    <div class="row">

                <div class="col-md-3">
            <nav class="nav-left hidden-xs hidden-sm" id="sideNav">
    <ul class="nav nav-stacked" data-spy="affix" data-offset-top="59" role="tablist">
                                <li>
                <a href="#1-1" title="Introduction">Introduction</a>
            </li>
                                <li>
                <a href="#1-1-1" title="Objectives&#x20;of&#x20;this&#x20;tutorial">Objectives of this tutor...</a>
            </li>
                                <li>
                <a href="#1-1-2" title="The&#x20;initial&#x20;setup">The initial setup</a>
            </li>
                                <li>
                <a href="#1-1-3" title="prooph&#x20;messages">prooph messages</a>
            </li>
                                                        <li>
                <a href="#1-1-4" title="Command&#x20;Query&#x20;Responsibility&#x20;Segregation">Command Query Responsibi...</a>
            </li>
                                <li>
                <a href="#1-1-5" title="Event&#x20;Sourcing">Event Sourcing</a>
            </li>
                                <li>
                <a href="#1-1-6" title="Quick&#x20;Version">Quick Version</a>
            </li>
            </ul>
</nav>
        </div>
                <div class="col-md-9">
<div id="section-main"><h1 id="1-1">Introduction</h1>
<p>On the following pages we will walk through all prooph components step by step
and take a look on how things work together. You will learn the basic concepts as well
as some advanced techniques to push your PHP applications up to the next level and
make them ready for the future.</p>
<h2 id="1-1-1">Objectives of this tutorial</h2>
<p>In the prooph ecosystem everything is bound together by messages.
So when you want to get started with prooph components you should know the
basic building block - <strong>prooph messages</strong>. Once you know how they work we give a short overview
of CQRS and Event Sourcing and why messages play an important role in this architecture.</p>
<h2 id="1-1-2">The initial setup</h2>
<p>To start with the tutorial you need PHP 7.1 and composer installed. If you're on Windows please consider using a Linux VM
for the tutorial. The tutorial is tested on Linux only and the commands needed for project set up (not many) are shown in
their Linux version only.</p>
<h2 id="1-1-3">prooph messages</h2>
<p>Every prooph component deals with messages in one way or the other so we've put them
in a common package to share them. Time to get our hands dirty and install the package.</p>
<p>First create an empty folder called <code>prooph_tutorial</code> and <code>cd</code> into it.</p>
<h3 id="1-1-3-1">Require prooph/common</h3>
<p><code>$ composer require prooph/common</code></p>
<p>This command will run composer that generates a fresh <code>composer.json</code> for us and adds <code>prooph/common</code>
as first package to our new project. Let's check what we've installed.</p>
<h3 id="1-1-3-2">The first message</h3>
<p>Create a file called <code>hello_world.php</code> with the following content and run it with <code>php</code>:</p>
<pre><code class="language-php">&lt;?php
//All prooph components use strict types enabled
declare(strict_types=1);

namespace Prooph\Tutorial;

use Prooph\Common\Messaging\Command;
use Prooph\Common\Messaging\PayloadConstructable;
use Prooph\Common\Messaging\PayloadTrait;

//Require composer's autoloader
require 'vendor/autoload.php';

//Our first message
final class SayHello extends Command implements PayloadConstructable
{
    use PayloadTrait;

    public function to(): string
    {
        return $this-&gt;payload['to'];
    }
}

$sayHello = new SayHello(['to' =&gt; 'World']);

echo 'Hello ' . $sayHello-&gt;to();

//Hello World

</code></pre>
<p>In the script above we've created our first message of message type <code>command</code>.
We've also used <code>Prooph\Common\Messaging\PayloadTrait</code> in conjunction with the <code>Prooph\Common\Messaging\PayloadConstructable</code> interface
to be able to instantiate our command with a <code>payload</code> - a simple array - and get access to it using
<code>$this-&gt;payload</code> within the message.
While this is a very easy and fast way to create message classes it is completely optional.
The most important thing to note here is that <code>Prooph\Common\Messaging\Command</code> implements <code>Prooph\Common\Messaging\Message</code></p>
<pre><code class="language-php">&lt;?php

declare(strict_types=1);

namespace Prooph\Common\Messaging;

use DateTimeImmutable;
use Ramsey\Uuid\Uuid;

interface Message extends HasMessageName
{
    public const TYPE_COMMAND = 'command';
    public const TYPE_EVENT = 'event';
    public const TYPE_QUERY = 'query';

    /**
     * Should be one of Message::TYPE_COMMAND, Message::TYPE_EVENT or Message::TYPE_QUERY
     */
    public function messageType(): string;

    public function uuid(): Uuid;

    public function createdAt(): DateTimeImmutable;

    public function payload(): array;

    public function metadata(): array;

    public function withMetadata(array $metadata): Message;

    /**
     * Returns new instance of message with $key =&gt; $value added to metadata
     *
     * Given value must have a scalar or array type.
     */
    public function withAddedMetadata(string $key, $value): Message;
}
</code></pre>
<p>That is the basic contract, an immutable message with a unique identifier, a type, an created at timestamp,
a message name (by extending the <code>HasMessageName</code> interface), payload and metadata.
Payload should only contain scalar types and arrays (no objects) and metadata only scalars to be truly immutable.</p>
<h2 id="1-1-4">Command Query Responsibility Segregation</h2>
<p>Command Query Responsibility Segregation - short CQRS - is one of the two main patterns we've built the
prooph components for. CQRS was first described by <a href="http://codebetter.com/gregyoung/">Greg Young</a>.
Our goal is to port his idea to the PHP world and make it easy to use for PHP developers.</p>
<p>The basic concept is very simple. Let's look at a common service class:</p>
<pre><code class="language-php">&lt;?php

declare(strict_types = 1);

namespace Prooph\Tutorial;

class UserService
{
    private $userRepository;

    public function __construct(UserRepository $repository)
    {
        $this-&gt;userRepository = $repository;
    }

    public function createUser(int $id, string $name, string $email): User
    {
        $user = new User($id);

        $user-&gt;setName($name);
        $user-&gt;setEmail($email);

        $this-&gt;userRepository-&gt;save($user);
        
        return $user;
    }
    
    public function getUser(int $id): User
    {
        $user = $this-&gt;userRepository-&gt;get($id);
        
        if(!$user) {
            throw UserNotFoundException::withId($id);
        }
        
        return $user;
    }
}

</code></pre>
<p>The <code>UserService</code> is responsible for all actions related to a user.
In a CQRS system this looks slightly different:</p>
<p><code>CreateUserHandler.php</code></p>
<pre><code class="language-php">&lt;?php

declare(strict_types = 1);

namespace Prooph\Tutorial;

class CreateUserHandler
{
    private $userRepository;

    public function __construct(UserRepository $repository)
    {
        $this-&gt;userRepository = $repository;
    }

    public function createUser(int $id, string $name, string $email): void
    {
        $user = new User($id);

        $user-&gt;setName($name);
        $user-&gt;setEmail($email);

        $this-&gt;userRepository-&gt;save($user);
    }
}

</code></pre>
<p><code>UserFinder.php</code></p>
<pre><code class="language-php">&lt;?php

declare(strict_types = 1);

namespace Prooph\Tutorial;

class UserFinder
{
    private $userRepository;

    public function __construct(UserRepository $repository)
    {
        $this-&gt;userRepository = $repository;
    }

    public function getUser(int $id): User
    {
        $user = $this-&gt;userRepository-&gt;get($id);

        if(!$user) {
            throw UserNotFoundException::withId($id);
        }

        return $user;
    }
}

</code></pre>
<p>Instead of one service, we have two separate services one for handling the write action
and one for handling the query. Note that <code>CreateUserHandler::createUser(): void</code> no longer returns
the new user object. The method signature follows a basic rule of CQRS:
<strong>Write operations don't have a return value</strong></p>
<p>To summarize CQRS in one sentence:</p>
<p>A CQRS system is divided into two parts, a write model to handle all state changes
and a read model to query that state.</p>
<p>While this looks like overkill in the first place it enables you to design write and read side
independent of each other. Let's look at a read-optimized <code>UserFinder</code></p>
<pre><code class="language-php">&lt;?php

declare(strict_types = 1);

namespace Prooph\Tutorial;

class UserFinder
{
    private $connection;

    public function __construct(Connection $connection)
    {
        $this-&gt;connection = $connection;
    }

    public function getUser(int $id): array
    {
        $userData = $this-&gt;connection-&gt;findOneBy(['id' =&gt; $id]);

        if(!$userData) {
            throw UserNotFoundException::withId($id);
        }

        return $userData;
    }
}

</code></pre>
<p>We no longer use the <code>UserRepository</code> but instead directly access the database.
So we avoid the object relational mapping and return pure user data from our finder.
We can do this because we know that our read model won't do anything with the data other than
forwarding it to a client that for example requires the data in JSON or XML format.
If it is quaranteed that no state changes happen within the read model, we don't need to deal with
objects as we don't need to enforce any rules. Select the data and return it to the client as fast as possible
that is the target of the read model.</p>
<p>The write model however has to protect invariants. At the moment our <code>user</code> object does a bad job on this.</p>
<pre><code class="language-php">$user = new User($id);

$user-&gt;setName($name);
$user-&gt;setEmail($email);
</code></pre>
<p>These three lines tell us that a <code>User</code> can exist in our system without a name and an email, only
the id is required. For most of the systems this is not true. What about this?</p>
<pre><code class="language-php">$user = User::create($id, $name, $email);
</code></pre>
<p>Yeah, looks better now. Let's put it in the handler.</p>
<pre><code class="language-php">&lt;?php

declare(strict_types = 1);

namespace Prooph\Tutorial;

class CreateUserHandler
{
    private $userRepository;

    public function __construct(UserRepository $repository)
    {
        $this-&gt;userRepository = $repository;
    }

    public function createUser(int $id, string $name, string $email): void
    {
        $user = User::create($id, $name, $email);

        $this-&gt;userRepository-&gt;save($user);
    }
}

</code></pre>
<p>Ok, but not perfect because we are missing intent. The code does not express why
a user is created.</p>
<p>The following code looks better, right?</p>
<pre><code class="language-php">&lt;?php

declare(strict_types = 1);

namespace Prooph\Tutorial;

class RegisterUserHandler
{
    private $userRepository;

    public function __construct(UserRepository $repository)
    {
        $this-&gt;userRepository = $repository;
    }

    public function registerUser(int $id, string $name, string $email): void
    {
        $user = User::register($id, $name, $email);

        $this-&gt;userRepository-&gt;save($user);
    }
}

</code></pre>
<p>Finally, we add some prooph flavour and change the method of the handler to handle a prooph message</p>
<pre><code class="language-php">&lt;?php

declare(strict_types = 1);

namespace Prooph\Tutorial;

class RegisterUserHandler
{
    private $userRepository;

    public function __construct(UserRepository $repository)
    {
        $this-&gt;userRepository = $repository;
    }

    public function handle(RegisterUser $command): void
    {
        $user = User::register($command-&gt;userId(), $command-&gt;userName(), $command-&gt;email());

        $this-&gt;userRepository-&gt;save($user);
    }
}

</code></pre>
<p>With a few changes we turned our original <code>UserService</code> into two distinct classes supporting the basic idea of CQRS.
In the last step we enabled the write side to handle a prooph command that expresses its intent of how the system state should change
(a new user should be registered) using the message name <code>RegisterUser</code> and payload of the command.
The <code>RegisterUserHandler</code> is a so called <em>glue component</em>. Its task is to take the command and
translate the intent into an action performed by the write model (in our case the user).
Finally, the command handler makes use of the infrastructure (represented by the <code>UserRepository</code>) to persist
the state change caused by the command.</p>
<h2 id="1-1-5">Event Sourcing</h2>
<p>Event Sourcing is covered in detail in the next chapter. What follows is a very basic introduction so that
you can get an idea of what you'll learn when continue reading.</p>
<p>In an event sourced system all state changes are described by events. The fact that a new user was registered in
our system would be one of those events. Another one would be that the user has logged in or changed the email address.</p>
<p>Let's analyze the last example. We start by looking at our database table after the user was registered.</p>
<table class="table">
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>email</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>John Doe</td>
<td>doe@test.com</td>
</tr>
</tbody>
</table>
<p>Applying CQRS again we end up with a new command <code>ChangeEmail</code>, an appropriate command handler and a matching action
in the write model owned by the responsible object <code>User::changeEmail</code></p>
<pre><code class="language-php">&lt;?php

declare(strict_types = 1);

namespace Prooph\Tutorial;

class ChangeEmailHandler
{
    private $userRepository;

    public function __construct(UserRepository $repository)
    {
        $this-&gt;userRepository = $repository;
    }

    public function handle(ChangeEmail $command): void
    {
        $user = $this-&gt;userRepository-&gt;get($command-&gt;userId());
        
        $user-&gt;changeEmail($command-&gt;newEmail());

        $this-&gt;userRepository-&gt;save($user);
    }
}

</code></pre>
<p>Performing a command like this:</p>
<pre><code class="language-php">$changeEmail = new ChangeEmail([
    'userId' =&gt; 1, 
    'newEmail' =&gt; 'john.doe@test.com'
]);

$handler-&gt;handle($changeEmail);

</code></pre>
<p>will result in an updated database row</p>
<table class="table">
<thead>
<tr>
<th>id</th>
<th>name</th>
<th>email</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>John Doe</td>
<td>john.doe@test.com</td>
</tr>
</tbody>
</table>
<p>What is wrong here? We've changed state but we don't know why and when it happened.
Wouldn't it be nice if we could look at the database and see what caused the state change?</p>
<p>What would you say if your database would give you this information instead?</p>
<pre><code class="language-json">[{
    event: UserWasRegistered,
    createdAt: 2017-01-13
    payload: {id: 1, name: "John Doe", email: "doe@test.com"}
},
{
    event: EmailWasChanged,
    createdAt: 2017-01-14
    payload: {id: 1, newEmail: "john.doe@test.com"}
}]
</code></pre>
<p>Welcome to the world of Event Sourcing. This is only the beginning. When you are done with the walk-through tutorial
you don't want to look back. Event Sourcing makes it so much simpler to create software that reflects intent and you have
all information available to find bugs faster and add new features without pain. Messages are the basic building block but
we need to look at a few other things. Fasten your seatbelt and enjoy the journey.</p>
<h2 id="1-1-6">Quick Version</h2>
<p>The next pages cover all the things you need to know about Event Sourcing. This includes working on an example project along
with detailed explanations. If you want to do a quick walk-through instead or get your hands dirty before the theory
then you can head over to <a href="https://pilsniak.com/cqrs-es-php-prooph/">Prooph: CQRS+ES in PHP. How to use. - by Marcin Pilśniak</a>.</p>
</div>        </div>
    </div>
</div>

<footer>
    <div class="links">
        <div class="container">
            <div class="row">
                <div class="prev col-xs-6">
                                            <a href="/tutorial/">Previous</a>                                    </div>
                <div class="next col-xs-6">
                                            <a href="/tutorial/why_event_sourcing.html">Next</a>                                    </div>
            </div>
        </div>
    </div>
    <div id="copyright">
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p>Powered by <a href="https://github.com/tobiju/bookdown-bootswatch-templates" title="Visit project to generate your own docs">Bookdown Bootswatch Templates</a>.</p>
                </div>
            </div>
        </div>
    </div>
</footer>
</div>
<a href="https://github.com/prooph/proophessor"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
        integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/0.6.0/lunr.min.js"></script>
<script src="http://bartaz.github.io/sandbox.js/jquery.highlight.js"></script>
<script src="https://tobiju.github.io/share/prismjs/main.js"></script>
<script src="https://tobiju.github.io/share/prismjs/prism.js"></script>
<script type="text/javascript">

    function Search() {
        this.store = {};
        this.index = lunr(function () {
            this.ref('id');
            this.field('title', {boost: 10});
            this.field('content');
        });
        this.searchResults = $('.js-search-results').addClass('list-search-results');
    }

    Search.prototype = {
        constructor: Search,
        init: function () {
            this.createIndex();
            this.bindEvents();
        },
        createIndex: function () {
            var $this = this,
                indexFilePath = $('.js-search-input').data('roothref') + 'index.json';

            $.getJSON(indexFilePath, function (data) {
                $.each(data, function (key, item) {
                    $this.index.add({
                        id: item.id,
                        title: item.title,
                        content: item.content
                    });

                    $this.store[item.id] = {
                        href: item.id,
                        title: item.title,
                        content: item.content
                    }
                });
            });
        },
        bindEvents: function () {
            var $this = this;

            $('html')
                .on('click', function (event) {
                    $this.close($(this), event);
                });

            $('.js-search-input, .js-search-results')
                .on('click', function (event) {
                    $this.click($(this), event);
                });

            $('.js-search-input')
                .on('focus', function (event) {
                    $this.focus($(this), event);
                })
                .on('keyup', function (event) {
                    $this.search($(this), event)
                })
                .on('keydown', function (event) {
                    if ($('.js-search-results ul').is(':visible')){
                        $this.navigation($(this), event)
                    }
                })
        },
        click: function (element, event) {
            event.stopPropagation();
        },
        focus: function (element, event) {
            this.searchInputWidth = element.css('width');
            element.animate({
                'width': 600
            }, 500);
            $('#js-navbar-collapse > ul').fadeOut();
        },
        close: function (element, event) {
            var $this = this;

            $('.js-search-results').hide();
            $('.js-search-input').animate({
                'width': $this.searchInputWidth
            }, 500);
            $('#js-navbar-collapse > ul').fadeIn();
        },
        search: function (element, event) {
            var $this = this;

            if (event.keyCode == 13 || event.keyCode == 38 || event.keyCode == 40) {
                return;
            }

            var query = element.val(),
                results = $this.index.search(query);

            if (!results.length) {
                $this.searchResults.empty();
                return;
            }

            var resultsList = results.reduce(function (ul, result) {
                var item = $this.store[result.ref];
                var title = $('<b>').text(item.title);

                var cropText = $this.cropText(item.content, query);
                if (cropText.length === 0) {
                    cropText = $('<p>').html(item.content.substring(0, 120) + "...");
                }
                var content = content = $('<p>').html(cropText);

                var div = $('<div>')
                    .append(title)
                    .append(content);
                var a = $('<a>').attr('href', item.href)
                    .append(div);
                var li = $('<li>')
                    .append(a);
                ul.append(li);

                return ul;
            }, $('<ul>'));

            this.searchResults.html(resultsList);

            $('.js-search-results').show();
            $(".js-search-results li:first-child").addClass('selected');
        },
        cropText: function (content, query) {
            var cropedText = '',
                re = new RegExp("\\s?(.{0,30})?" + query + ".*?\\b(.{0,30}.)?\\s?", "gi");

            $.each(content.match(re), function (key, value) {
                cropedText += '...' + value + '...';
            });

            return cropedText;
        },
        navigation: function (element, event) {
            var selected = null,
                listSelector = ".js-search-results ul",
                listItemSelector = listSelector + " li",
                selectedListItemSelector = listItemSelector + ".selected",
                selectedListItemSelectorAnchor = listItemSelector + ".selected a";

            // enter
            if (event.keyCode == 13) {
                event.preventDefault();
                this.close();
                window.location.replace($(selectedListItemSelectorAnchor).attr('href'));
            }

            // up
            if (event.keyCode == 38) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.prev().length == 0) {
                    selected.siblings().last().addClass("selected");
                } else {
                    selected.prev().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListUp(selected);
            }

            // down
            if (event.keyCode == 40) {
                selected = $(selectedListItemSelector);
                $(listItemSelector).removeClass("selected");

                if (selected.next().length == 0) {
                    selected.siblings().first().addClass("selected");
                } else {
                    selected.next().addClass("selected");
                }

                selected = $(selectedListItemSelector);
                this.scrollListDown(selected);
            }
        },
        scrollListDown: function (element) {
            var ul = element.parent(),
                ulHeight = ul.height(),
                ulBottomPosition = ulHeight + ul.scrollTop(),
                liBottomPosition = element.position().top + element.height();

            if (liBottomPosition > ulBottomPosition) {
                ul.scrollTop(liBottomPosition - ulHeight);
            }

            if (element.is(':first-child')) {
                ul.scrollTop(0);
            }
        },
        scrollListUp: function (element) {
            var ul = element.parent(),
                ulTopPosition = ul.scrollTop(),
                liTopPosition = element.position().top;

            if (liTopPosition < ulTopPosition) {
                ul.scrollTop(element.position().top);
            }

            if (element.is(':last-child')) {
                ul.scrollTop(element.position().top - element.height());
            }
        }
    };

    $(function () {
        var search = new Search();
        search.init();
    });
</script>
</body></html>
